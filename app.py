# ==============================================================================
# ส่วนที่ 1: การติดตั้งและนำเข้าไลบรารีที่จำเป็น
# ==============================================================================
import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import io
import json
import urllib.request

# ==============================================================================
# ตั้งค่าหน้าเว็บให้เป็นแบบ Wide Mode เพื่อใช้พื้นที่เต็มความกว้าง
# ==============================================================================
st.set_page_config(layout="wide")

# ==============================================================================
# ส่วนที่ 2: การเตรียมข้อมูล (ใช้ฟังก์ชัน Caching เพื่อให้โหลดครั้งเดียว)
# ==============================================================================
@st.cache_data
def load_data():
    # --- ข้อมูลชุดที่ 1: ยอดขายรายจังหวัด ---
    data1_str = """
    ที่	"เขตตรวจ
    ราชการที่"	จังหวัด	"ตุลาคม 2566
    (บาท)"	"พฤศจิกายน 2566
    (บาท)"	"ธันวาคม 2566
    (บาท)"	"มกราคม 2567
    (บาท)"	"กุมภาพันธ์ 2567
    (บาท)"	"มีนาคม 2567
    (บาท)"	"เมษายน 2567
    (บาท)"	"พฤษภาคม 2567
    (บาท)"	"มิถุนายน 2567
    (บาท)"	"กรกฎาคม 2567
    (บาท)"	"สิงหาคม 2567
    (บาท)"	"กันยายน 2567
    (บาท)"	"รวม 12 เดือน
    (บาท)"
    1	1	นนทบุรี	245,625,668.00	210,766,488.00	272,289,848.00	265,082,420.00	261,525,500.00	244,857,493.00	248,708,535.00	235,904,980.00	258,507,238.00	238,045,678.00	269,465,377.00	242,563,732.00	2,993,342,957.00
    2	1	ปทุมธานี	192,509,104.00	197,020,127.00	203,956,285.00	192,396,842.00	178,466,573.00	175,775,064.00	112,991,880.00	94,345,643.00	101,519,237.00	71,724,372.00	70,529,872.00	64,672,082.00	1,655,907,081.00
    3	1	พระนครศรีอยุธยา	689,805,749.00	696,537,075.00	701,327,486.00	722,202,515.00	678,371,275.00	439,844,454.00	618,198,300.00	601,061,413.00	491,229,452.00	657,009,792.00	645,160,574.00	321,893,299.00	7,262,641,384.00
    4	1	สระบุรี	207,633,501.00	212,469,515.00	215,802,062.00	220,108,265.00	223,968,650.00	213,836,505.00	402,224,891.00	449,988,033.00	509,932,259.00	479,368,185.00	486,239,442.00	441,379,392.00	4,062,950,700.00
    5	2	อ่างทอง	195,522,938.00	204,574,530.00	216,361,037.00	269,824,532.00	294,743,757.00	282,620,479.00	186,123,344.00	184,467,044.00	185,097,143.00	146,992,450.00	145,481,155.00	161,114,815.00	2,472,923,224.00
    6	2	ลพบุรี	302,598,380.00	354,487,540.00	387,219,307.00	396,704,262.00	318,658,581.00	304,992,830.00	263,248,900.00	218,301,800.00	226,603,762.00	228,851,160.00	243,027,835.00	230,071,463.00	3,474,765,820.00
    7	2	สิงห์บุรี	64,800,056.00	71,171,936.00	110,680,581.00	117,566,381.00	101,557,339.00	93,827,002.00	64,800,302.00	63,128,616.00	65,937,563.00	61,033,194.00	67,858,445.00	73,141,748.00	955,503,163.00
    8	2	ชัยนาท	123,038,094.60	143,969,615.00	160,440,730.00	153,473,348.00	147,140,869.00	128,454,681.00	154,474,792.00	195,296,768.72	181,488,036.72	61,000,000.57	54,904,517.00	37,654,631.39	1,541,336,084.00
    9	3	สมุทรปราการ	527,190,595.00	894,290,512.00	871,325,116.00	732,189,516.00	686,518,430.00	521,320,800.00	703,105,690.00	624,959,107.00	694,960,487.00	579,469,600.00	598,724,370.00	560,214,599.00	7,994,268,822.00
    10	3	ฉะเชิงเทรา	97,169,643.00	101,551,882.00	96,804,386.00	103,773,112.00	110,592,906.00	121,318,611.00	162,413,580.00	157,307,693.00	146,187,118.00	133,262,296.00	121,821,116.00	113,276,641.00	1,465,478,984.00
    11	3	ปราจีนบุรี	407,773,670.00	478,753,522.00	513,500,480.00	530,114,960.00	479,266,150.00	424,144,460.00	444,937,410.00	467,424,860.00	451,868,612.00	401,613,700.00	405,412,302.00	331,721,960.00	5,336,532,086.00
    12	3	นครนายก	261,589,788.00	273,255,233.00	272,838,736.00	271,684,298.00	270,892,428.00	208,843,878.00	257,014,520.00	258,831,220.00	348,783,632.00	312,364,141.00	346,590,793.00	334,211,093.00	3,416,899,760.00
    13	3	สระแก้ว	147,501,140.00	155,957,340.00	166,525,385.00	179,072,575.00	182,721,205.00	202,826,295.00	226,578,815.00	187,693,320.00	184,840,910.00	161,276,520.00	167,036,070.00	161,501,422.00	2,123,530,997.00
    14	4	ราชบุรี	1,222,765,499.50	1,257,307,122.81	1,235,933,815.83	1,391,692,946.64	1,191,602,033.86	1,265,872,204.42	423,412,019.90	459,511,243.40	309,078,165.30	325,202,693.30	340,191,960.80	312,208,209.20	9,734,777,914.96
    15	4	กาญจนบุรี	345,558,563.00	368,885,726.00	403,195,155.00	427,198,192.00	373,437,180.00	366,206,722.00	418,866,370.00	408,869,736.00	386,792,911.00	421,308,595.00	429,406,069.00	361,950,418.00	4,711,675,637.00
    16	4	สุพรรณบุรี	516,099,158.00	478,319,832.00	472,826,198.00	521,868,974.00	494,467,057.00	580,345,991.00	358,442,062.00	315,801,794.00	289,788,862.00	255,254,655.00	223,100,560.00	180,136,600.00	4,686,451,743.00
    17	4	นครปฐม	1,810,589,575.79	1,830,860,310.22	1,963,968,968.92	1,955,408,807.42	1,954,883,081.88	1,919,598,387.14	1,771,517,517.78	1,731,734,341.89	1,758,010,342.66	1,863,373,355.60	1,925,794,997.20	1,854,357,519.00	22,340,097,205.50
    18	5	สมุทรสาคร	588,103,299.00	614,015,069.00	733,224,869.00	745,738,221.00	630,053,822.00	636,150,734.00	601,140,360.00	573,119,015.00	559,159,730.00	568,084,590.00	671,334,755.00	641,715,155.00	7,561,839,619.00
    19	5	สมุทรสงคราม	161,394,863.00	146,823,701.00	142,192,601.00	171,551,067.00	156,112,596.00	197,760,020.02	207,244,720.02	217,502,965.02	223,492,665.02	164,040,790.02	182,141,764.90	192,289,985.00	2,162,547,738.00
    20	5	เพชรบุรี	623,819,113.00	681,612,345.00	720,166,309.00	712,800,025.00	700,868,823.00	692,580,869.00	758,930,950.00	733,465,450.00	731,656,615.00	741,667,616.00	719,179,724.00	718,951,119.00	8,535,698,958.00
    21	5	ประจวบคีรีขันธ์	112,448,720.00	130,067,620.00	167,332,730.00	155,994,660.00	130,292,730.00	129,966,210.00	130,346,840.00	121,911,470.00	119,325,370.00	121,227,690.00	124,021,970.00	117,459,550.00	1,560,395,560.00
    22	6	นครศรีธรรมราช	361,521,865.00	362,386,941.00	407,677,146.00	387,563,463.00	378,773,166.00	313,583,958.00	261,544,785.00	235,817,693.00	239,068,105.00	241,571,890.00	236,243,382.00	232,347,252.00	3,658,099,646.00
    23	6	สุราษฎร์ธานี	601,806,053.00	631,265,647.00	651,642,751.00	664,035,220.00	687,890,359.00	668,942,950.00	656,590,809.00	629,971,642.00	742,670,997.00	563,265,433.00	551,735,936.00	555,521,453.00	7,605,339,250.00
    24	6	ชุมพร	171,636,312.00	177,427,382.00	196,081,903.00	195,267,388.00	188,006,377.00	189,176,050.00	195,232,984.00	190,910,539.00	195,465,680.00	195,147,876.00	193,583,001.00	171,133,126.00	2,259,068,618.00
    25	6	พัทลุง	200,436,320.00	201,022,659.00	212,721,928.00	204,764,582.00	200,919,656.00	198,140,882.00	177,509,546.00	176,227,804.00	176,809,349.00	177,042,034.00	177,478,673.00	175,494,603.00	2,278,568,036.00
    26	7	กระบี่	147,544,888.00	162,226,629.00	176,973,249.00	172,056,840.67	167,136,786.41	158,605,695.75	86,866,402.30	72,888,767.41	71,551,857.93	67,103,871.25	79,711,886.28	76,503,127.67	1,439,170,001.67
    27	7	พังงา	124,582,501.00	128,427,206.00	136,151,823.00	139,161,651.00	148,491,630.00	154,635,644.00	117,075,833.00	113,894,231.60	113,643,797.60	113,696,376.60	110,713,093.60	113,829,697.60	1,514,303,485.00
    28	7	ภูเก็ต	291,398,822.00	302,757,012.00	312,923,282.00	299,551,210.00	262,268,850.00	253,499,600.00	137,695,700.00	91,906,190.00	110,960,940.00	118,611,640.00	122,654,640.00	131,206,140.00	2,435,434,026.00
    29	7	ระนอง	170,869,424.00	169,282,092.00	160,516,210.00	181,616,224.00	179,722,191.00	163,454,234.00	208,620,794.00	214,954,678.00	220,345,826.00	195,723,108.00	226,285,155.00	201,101,706.00	2,292,491,642.00
    30	7	ตรัง	271,210,368.00	269,345,250.00	282,059,710.00	278,312,310.00	262,633,270.00	262,840,690.00	275,489,350.00	274,747,030.00	272,676,475.00	276,596,940.00	277,074,175.00	274,611,000.00	3,277,596,568.00
    31	8	สงขลา	396,832,112.00	393,751,851.00	422,828,940.00	464,864,289.00	472,157,112.00	446,092,445.00	321,546,991.00	312,369,982.00	309,427,905.00	385,748,023.00	338,552,971.00	347,421,550.00	4,611,594,171.00
    32	8	สตูล	141,214,981.00	150,844,063.00	156,032,331.00	155,496,911.00	157,335,061.00	156,079,435.00	169,771,339.00	161,702,172.00	166,753,740.00	175,456,982.00	182,962,317.00	177,883,312.00	1,951,532,644.00
    33	8	ปัตตานี	375,811,690.00	384,522,240.00	398,396,828.00	385,459,153.00	371,969,292.00	348,117,989.00	344,341,498.00	348,091,318.00	352,135,775.00	366,454,438.00	374,095,371.00	372,762,202.00	4,422,157,794.00
    34	8	ยะลา	269,310,620.00	288,683,873.00	364,142,199.00	320,083,544.00	321,308,975.00	298,848,307.00	326,235,980.00	319,467,149.00	312,643,800.00	295,180,370.00	287,557,085.00	277,719,650.00	3,681,181,552.00
    35	8	นราธิวาส	239,184,500.00	251,817,853.00	263,697,647.00	264,924,549.00	248,635,543.00	236,291,603.00	278,613,498.00	276,033,900.00	276,054,052.00	275,868,915.00	282,059,183.00	270,114,328.00	3,163,295,571.00
    36	9	ชลบุรี	296,199,657.60	308,132,372.60	362,765,626.80	394,321,370.00	294,567,475.00	291,872,826.00	302,040,141.00	300,593,351.00	315,460,611.00	289,567,095.00	438,522,705.00	362,134,711.00	3,956,177,942.00
    37	9	ระยอง	297,001,037.00	302,287,453.00	309,664,608.00	302,016,253.00	290,142,944.00	293,242,483.00	312,010,173.00	403,392,496.00	382,210,246.00	327,798,841.00	328,304,989.00	295,484,807.00	3,843,556,330.00
    38	9	จันทบุรี	212,131,805.00	328,386,726.00	509,334,711.00	510,439,915.00	353,728,020.00	505,843,588.00	76,720,598.00	132,898,318.00	80,927,261.00	52,644,089.00	52,560,541.00	55,121,737.00	2,870,737,309.00
    39	9	ตราด	131,676,671.00	130,804,167.00	135,664,537.00	135,061,967.00	139,114,065.00	145,406,455.00	143,441,305.00	150,690,094.00	154,122,994.00	155,700,205.00	159,202,895.00	307,711,209.00	1,888,595,564.00
    40	10	บึงกาฬ	136,305,618.00	137,878,150.00	144,368,538.00	142,159,047.00	132,086,569.00	117,589,121.00	135,478,015.00	136,494,558.00	137,284,966.00	137,045,731.00	140,558,124.00	130,302,855.00	1,627,551,292.00
    41	10	หนองบัวลำภู	201,242,729.00	202,846,469.00	235,548,708.00	222,729,440.00	228,086,790.00	213,105,726.00	172,894,046.00	180,401,216.00	187,335,416.00	179,008,889.00	192,402,756.00	189,954,756.00	2,405,556,941.00
    42	10	อุดรธานี	729,417,412.00	766,708,566.00	856,869,341.00	793,100,888.00	764,884,987.00	759,453,657.00	790,247,483.00	797,822,309.00	802,029,380.00	810,833,854.00	765,570,543.00	679,121,612.00	9,316,060,032.00
    43	10	เลย	283,857,523.04	299,288,795.00	329,779,014.00	342,416,912.48	312,598,039.02	271,641,198.50	266,955,787.05	278,620,773.00	279,912,346.58	286,212,486.91	277,529,390.42	231,202,297.00	3,460,014,563.00
    44	10	หนองคาย	119,423,129.00	120,894,940.00	134,469,272.00	153,457,701.00	134,150,299.00	146,890,060.00	127,435,522.00	137,358,624.00	141,361,186.00	144,274,966.00	160,218,174.00	163,737,624.00	1,683,671,497.00
    45	11	สกลนคร	426,105,889.76	441,275,995.19	459,265,192.11	472,804,692.02	496,103,144.00	419,627,572.00	467,771,649.80	450,273,552.80	363,715,244.00	341,344,767.00	361,986,168.00	312,025,994.00	5,012,299,860.68
    46	11	นครพนม	172,959,100.00	191,610,850.00	212,346,404.00	226,627,315.00	239,777,684.00	237,193,970.00	204,253,915.00	194,426,061.00	187,746,897.00	174,673,547.00	160,342,332.00	134,248,480.00	2,336,206,555.00
    47	11	มุกดาหาร	146,850,683.00	147,997,807.00	146,993,440.00	157,844,191.00	144,988,597.00	143,346,264.00	111,581,855.00	92,537,359.00	100,044,183.00	97,065,003.00	98,071,428.00	105,948,530.00	1,493,269,340.00
    48	12	ขอนแก่น	1,215,123,406.00	1,238,634,039.00	1,315,581,409.60	1,361,906,391.60	1,340,337,698.60	1,212,748,339.60	1,100,123,305.22	1,164,192,289.74	1,151,642,234.60	1,019,982,493.04	383,291,126.00	389,327,152.00	12,892,889,885.00
    49	12	มหาสารคาม	281,045,237.72	280,846,345.74	364,753,828.44	395,048,899.68	364,984,109.16	363,610,714.18	352,667,505.78	328,270,873.70	321,973,225.60	248,722,853.92	256,936,210.90	129,920,947.18	3,688,780,752.00
    50	12	ร้อยเอ็ด	448,922,016.00	588,424,411.00	639,947,301.00	699,619,191.00	629,227,456.00	749,751,839.00	512,923,061.00	529,836,011.00	487,840,931.00	424,607,701.00	471,009,351.00	364,842,199.00	6,546,951,468.00
    51	12	กาฬสินธุ์	416,256,370.00	450,132,019.00	842,126,243.00	836,748,890.00	699,035,497.00	619,273,572.00	360,258,725.00	497,143,039.00	664,841,342.00	548,941,810.00	612,743,995.00	409,658,631.00	6,957,160,133.00
    52	13	ศรีสะเกษ	717,473,145.00	727,576,637.00	799,840,507.00	862,314,770.00	890,142,934.00	818,824,894.00	802,918,434.00	663,911,585.00	580,924,000.00	543,078,522.00	524,573,931.00	521,787,794.00	8,453,367,153.00
    53	13	อุบลราชธานี	732,828,739.00	752,734,543.00	801,413,240.00	800,754,350.00	784,532,344.00	807,457,937.34	798,949,647.75	792,802,277.75	823,717,964.75	820,771,940.75	817,692,458.97	793,796,695.97	9,527,452,139.28
    54	13	ยโสธร	127,648,780.00	194,198,350.00	214,861,690.00	201,452,410.00	170,916,100.00	182,215,468.00	187,535,222.00	199,950,720.00	197,678,087.00	181,226,940.00	163,937,340.00	168,105,670.00	2,189,726,777.00
    55	13	อำนาจเจริญ	300,025,728.00	327,535,786.00	344,961,622.00	357,539,249.00	340,179,854.00	342,265,744.00	355,542,155.00	337,210,614.00	338,334,987.00	324,380,343.00	325,115,613.00	312,177,657.00	4,005,269,352.00
    56	14	นครราชสีมา	938,836,120.00	951,955,923.00	971,998,825.00	899,985,815.00	539,106,216.00	400,863,649.00	946,370,796.00	944,629,925.00	945,835,087.00	952,601,489.00	1,504,848,627.00	401,528,519.00	10,398,560,991.00
    57	14	บุรีรัมย์	345,642,249.00	342,127,083.00	361,477,480.00	367,898,865.00	360,963,155.00	376,223,487.00	356,259,091.00	358,983,270.00	367,123,086.00	403,438,541.00	438,963,036.00	397,181,866.00	4,476,281,209.00
    58	14	สุรินทร์	431,650,706.00	452,446,360.00	490,514,134.00	498,821,400.00	501,934,460.00	462,181,595.00	465,099,225.00	471,555,335.00	490,764,865.00	502,565,575.00	525,047,340.00	440,697,410.00	5,733,278,405.00
    59	14	ชัยภูมิ	177,714,463.95	236,094,618.95	256,716,725.95	312,093,798.95	326,466,597.95	271,714,007.95	292,863,604.90	240,282,032.80	249,353,852.20	244,402,447.00	246,586,636.05	198,831,009.05	3,053,119,795.70
    60	15	เชียงใหม่	1,180,854,572.00	1,337,763,856.00	1,480,465,437.00	1,959,962,793.00	2,123,559,119.00	2,054,964,260.00	1,280,801,356.00	1,018,499,421.00	1,021,207,790.22	1,016,829,312.22	1,042,741,682.22	833,182,393.00	16,350,831,991.66
    61	15	ลำพูน	467,608,380.00	475,935,980.00	489,554,430.00	410,836,060.00	413,430,310.00	644,021,580.00	566,677,950.00	486,032,650.00	504,268,700.00	360,447,300.00	301,309,660.00	277,917,990.00	5,398,040,990.00
    62	15	ลำปาง	161,871,689.00	182,890,979.50	212,804,705.50	201,106,531.00	159,306,152.50	162,270,818.00	167,259,435.00	147,661,693.00	152,006,990.00	164,027,652.00	169,107,481.50	155,393,910.00	2,035,708,037.00
    63	15	แม่ฮ่องสอน	44,555,547.00	79,412,366.00	90,251,780.00	80,697,801.00	57,296,062.00	31,952,843.00	16,599,287.00	18,440,278.00	35,200,840.00	23,787,593.00	27,395,472.70	22,091,498.48	527,681,368.18
    64	16	แพร่	162,684,719.00	151,635,723.00	172,051,750.00	148,527,288.00	148,858,491.00	169,817,585.00	145,970,780.00	148,924,665.00	153,378,828.00	157,225,966.00	153,824,813.00	160,556,136.00	1,873,456,744.00
    65	16	น่าน	158,198,989.23	156,896,649.23	162,614,475.00	232,008,840.00	231,547,030.00	229,489,657.00	193,083,465.00	199,103,426.00	184,711,276.00	162,575,565.00	166,341,200.00	113,589,078.00	2,190,159,650.46
    66	16	พะเยา	188,244,925.00	212,206,975.00	267,313,544.00	276,616,153.00	226,243,389.00	209,366,435.00	129,670,650.00	173,188,817.00	267,492,831.00	233,462,240.00	223,065,439.00	132,976,656.00	2,539,848,054.00
    67	16	เชียงราย	436,788,585.00	461,632,108.00	554,074,447.00	552,473,908.00	586,104,438.00	606,550,631.00	447,639,629.00	407,058,946.00	410,626,441.00	424,207,953.00	490,236,928.00	407,018,645.00	5,784,412,659.00
    68	17	อุตรดิตถ์	115,900,547.00	122,493,777.00	123,042,834.00	113,546,070.00	176,590,356.00	198,972,772.00	198,774,579.00	536,063,554.00	465,922,517.00	582,746,082.00	263,009,913.00	62,877,610.00	2,959,940,611.00
    69	17	ตาก	297,355,883.00	313,889,430.00	345,671,471.00	334,229,102.00	281,968,668.00	288,213,347.00	286,490,609.00	270,351,119.00	266,752,016.00	264,133,870.00	275,544,850.00	229,685,629.00	3,454,285,994.00
    70	17	สุโขทัย	160,644,094.00	210,481,010.00	237,410,970.00	210,525,890.00	194,952,180.00	163,939,936.00	167,242,000.00	176,102,517.00	173,089,248.00	174,754,414.00	219,844,484.00	146,623,632.00	2,235,610,375.00
    71	17	พิษณุโลก	131,942,462.00	134,127,282.00	145,306,050.00	178,597,171.00	144,462,410.00	118,385,730.00	133,296,881.00	90,514,834.00	60,310,818.00	92,726,538.00	32,781,091.00	20,448,559.00	1,282,899,826.00
    72	17	เพชรบูรณ์	284,561,745.00	328,764,965.00	354,917,200.00	599,386,590.00	491,307,660.00	306,030,143.40	244,153,459.90	304,646,734.90	261,126,531.90	258,558,333.70	212,931,190.00	201,385,101.00	3,847,769,654.80
    73	18	นครสวรรค์	322,786,629.00	349,090,748.00	423,578,298.00	474,364,591.00	412,332,743.00	376,699,866.00	308,099,187.00	286,949,330.00	289,465,975.00	282,020,211.00	308,253,477.00	273,029,328.33	4,106,670,383.33
    74	18	อุทัยธานี	174,962,582.00	168,963,282.00	187,845,362.00	179,388,622.00	198,764,546.00	149,731,660.00	167,614,400.00	164,935,250.00	176,846,140.00	170,599,512.00	123,580,240.00	110,319,504.00	1,973,551,100.00
    75	18	กำแพงเพชร	192,411,656.74	203,671,074.66	215,401,298.18	221,469,130.49	227,660,451.31	219,536,660.02	279,432,383.44	262,229,547.66	297,656,298.84	291,073,699.18	332,922,365.24	252,512,186.15	2,995,976,751.91
    76	18	พิจิตร	59,406,106.00	81,473,844.00	88,704,641.00	103,092,206.00	130,911,604.00	92,736,265.00	103,187,586.00	88,278,970.00	78,310,425.00	77,037,778.00	78,708,087.00	71,438,629.00	1,053,286,141.00
    """

    # --- ข้อมูลชุดที่ 2: สรุปรายได้ตามช่องทาง ---
    data2_str = """
    ที่	เดือน	ในประเทศ(ออฟไลน์)	ในประเทศ(ออนไลน์)	ต่างประเทศ(ออฟไลน์)	ต่างประเทศ(ออนไลน์)	รวม
    1	ตุลาคม 2566	24,868,670,112.17	886,262,153.26	607,544,410.00	71,538,224.50	26,434,014,899.93
    2	พฤศจิกายน 2566	26,439,753,164.45	1,026,477,222.72	723,574,467.28	78,801,340.45	28,268,606,194.90
    3	ธันวาคม 2566	28,954,077,120.63	1,177,260,077.41	748,105,136.89	82,586,788.40	30,962,029,123.33
    4	มกราคม 2567	29,885,339,609.31	1,303,359,324.92	809,590,383.64	75,306,404.08	32,073,595,721.95
    5	กุมภาพันธ์ 2567	28,126,566,594.25	1,315,772,579.05	782,323,562.02	72,077,164.37	30,296,739,899.69
    6	มีนาคม 2567	26,907,257,131.47	1,258,881,837.90	933,832,853.22	74,505,705.73	29,174,477,528.32
    7	เมษายน 2567	24,803,702,338.77	1,042,086,451.18	632,408,544.17	71,994,873.72	26,550,192,207.84
    8	พฤษภาคม 2567	24,601,808,404.85	965,282,577.46	652,652,365.38	63,124,698.70	26,282,868,046.39
    9	มิถุนายน 2567	24,712,722,210.06	984,713,465.26	574,612,094.17	62,974,699.43	26,335,022,468.92
    10	กรกฎาคม 2567	23,810,114,022.20	1,002,527,591.62	510,170,421.75	63,931,083.49	25,386,743,119.06
    11	สิงหาคม 2567	23,906,870,634.70	1,008,090,662.03	538,531,178.45	52,252,146.60	25,505,744,621.78
    12	กันยายน 2567	20,259,886,628.40	881,571,468.50	599,405,392.45	55,166,737.67	21,796,030,227.02
    """

    # --- ข้อมูลชุดที่ 3: สรุปตามประเภทสินค้า ---
    data3_str = """
    ที่	เดือน	"อาหาร
    (บาท)"	"เครื่องดื่ม
    (บาท)"	"ผ้าและเครื่องแต่งกาย
    (บาท)"	"เครื่องใช้และ
    เครื่องประดับตกแต่ง
    (บาท)"	"สมุนไพรที่
    ไม่ใช่อาหารและยา
    (บาท)"	"รวมทั้งสิ้น
    (บาท)"
    1	ตุลาคม 2566	12,956,019,480.47	1,423,645,106.48	4,818,821,484.00	5,085,298,737.35	2,150,230,091.63	25,476,214,522.17
    2	พฤศจิกายน 2566	13,874,527,663.67	1,538,536,934.90	5,049,333,205.51	5,477,161,358.43	2,329,047,032.39	27,163,327,631.73
    3	ธันวาคม 2566	14,893,424,956.72	1,707,495,161.43	5,798,785,720.28	5,987,124,582.29	2,575,198,702.61	29,702,182,257.52
    4	มกราคม 2567	15,871,436,806.70	1,748,397,669.64	5,657,510,920.48	6,181,388,333.85	2,614,861,991.28	30,694,929,992.95
    5	กุมภาพันธ์ 2567	15,027,998,338.19	1,640,612,294.29	5,219,386,481.68	5,926,118,361.58	2,482,624,423.95	28,908,890,156.27
    6	มีนาคม 2567	14,451,419,224.52	1,573,213,650.63	5,089,245,091.96	5,702,875,881.84	2,357,723,679.37	27,841,089,984.69
    7	เมษายน 2567	12,741,034,100.98	1,388,561,768.71	4,857,378,158.83	5,411,151,289.74	2,152,066,889.58	25,436,110,882.94
    8	พฤษภาคม 2567	12,805,070,707.26	1,330,358,397.25	4,837,850,317.91	5,194,650,966.79	2,114,937,657.18	25,254,460,770.23
    9	มิถุนายน 2567	12,562,536,620.17	1,339,483,273.77	5,013,026,868.80	5,271,892,971.60	2,148,082,734.58	25,287,334,304.23
    10	กรกฎาคม 2567	12,242,538,057.10	1,320,149,446.44	4,763,790,762.28	5,002,477,580.17	2,057,787,273.07	24,320,284,443.95
    11	สิงหาคม 2567	12,229,630,799.54	1,375,201,089.81	4,764,279,727.17	5,089,532,192.09	2,047,100,813.17	24,445,401,813.15
    12	กันยายน 2567	10,523,566,770.03	1,205,246,732.06	3,764,020,572.13	4,370,073,038.02	1,933,123,114.78	20,859,292,020.85
    """

    def clean_and_load_data(data_str):
        return pd.read_csv(io.StringIO(data_str), sep='\t', quotechar='"', engine='python', on_bad_lines='skip')
    
    # --- *** ส่วนที่แก้ไข *** ---
    # โหลด df1
    df1_raw = clean_and_load_data(data1_str)
    # ทำความสะอาดชื่อคอลัมน์ทั้งหมดก่อน
    df1_raw.columns = [col.replace('\n', ' ').replace('(บาท)', '').replace('"', '').strip() for col in df1_raw.columns]
    # กำหนดรายชื่อคอลัมน์เดือนที่เราต้องการเก็บไว้
    month_cols = [col for col in df1_raw.columns if '2566' in col or '2567' in col]
    # สร้าง list ของคอลัมน์ทั้งหมดที่ต้องการเก็บ (จังหวัด + เดือน)
    columns_to_keep = ['จังหวัด'] + month_cols
    # สร้าง DataFrame ใหม่โดยเลือกเฉพาะคอลัมน์ที่ต้องการ
    df1 = df1_raw[columns_to_keep].copy()
    # ตั้งค่า index
    df1.set_index('จังหวัด', inplace=True)
    # --- *** จบส่วนที่แก้ไข *** ---

    # โหลด df2 (เหมือนเดิม)
    df2 = clean_and_load_data(data2_str)
    df2 = df2.drop(columns=['ที่', 'รวม'])
    df2['เดือน'] = df2['เดือน'].str.strip()
    df2.set_index('เดือน', inplace=True)
    for col in df2.columns:
        df2[col] = df2[col].astype(str).str.replace(',', '').astype(float)

    # โหลด df3 (เหมือนเดิม)
    df3 = clean_and_load_data(data3_str)
    df3.columns = [col.replace('\n', ' ').replace('(บาท)', '').replace('"', '').strip() for col in df3.columns]
    df3 = df3.drop(columns=['ที่', 'รวมทั้งสิ้น'])
    df3['เดือน'] = df3['เดือน'].str.strip()
    df3.set_index('เดือน', inplace=True)
    for col in df3.columns:
        if col != 'เดือน':
            df3[col] = df3[col].astype(str).str.replace(',', '').astype(float)
        
    df1_melted = df1.reset_index().melt(id_vars='จังหวัด', var_name='เดือน', value_name='ยอดขาย')
    national_average = df1.mean()
    
    return df1, df2, df3, df1_melted, national_average, month_cols

@st.cache_data
def load_geojson():
    geojson_url = "https://raw.githubusercontent.com/apisit/thailand.json/master/thailand.json"
    with urllib.request.urlopen(geojson_url) as url:
        thailand_geojson = json.load(url)
    return thailand_geojson

# โหลดข้อมูลทั้งหมด
df1, df2, df3, df1_melted, national_average, month_cols = load_data()
thailand_geojson = load_geojson()

# เตรียมข้อมูลแผนที่
province_name_map = {
    'กรุงเทพมหานคร': 'Bangkok', 'สมุทรปราการ': 'Samut Prakan', 'นนทบุรี': 'Nonthaburi', 'ปทุมธานี': 'Pathum Thani',
    'พระนครศรีอยุธยา': 'Phra Nakhon Si Ayutthaya', 'อ่างทอง': 'Ang Thong', 'ลพบุรี': 'Lopburi', 'สิงห์บุรี': 'Sing Buri',
    'ชัยนาท': 'Chai Nat', 'สระบุรี': 'Saraburi', 'ชลบุรี': 'Chon Buri', 'ระยอง': 'Rayong', 'จันทบุรี': 'Chanthaburi',
    'ตราด': 'Trat', 'ฉะเชิงเทรา': 'Chachoengsao', 'ปราจีนบุรี': 'Prachin Buri', 'นครนายก': 'Nakhon Nayok',
    'สระแก้ว': 'Sa Kaeo', 'นครราชสีมา': 'Nakhon Ratchasima', 'บุรีรัมย์': 'Buri Ram', 'สุรินทร์': 'Surin',
    'ศรีสะเกษ': 'Si Sa Ket', 'อุบลราชธานี': 'Ubon Ratchathani', 'ยโสธร': 'Yasothon', 'ชัยภูมิ': 'Chaiyaphum',
    'อำนาจเจริญ': 'Amnat Charoen', 'หนองบัวลำภู': 'Nong Bua Lam Phu', 'ขอนแก่น': 'Khon Kaen', 'อุดรธานี': 'Udon Thani',
    'เลย': 'Loei', 'หนองคาย': 'Nong Khai', 'มหาสารคาม': 'Maha Sarakham', 'ร้อยเอ็ด': 'Roi Et', 'กาฬสินธุ์': 'Kalasin',
    'สกลนคร': 'Sakon Nakhon', 'นครพนม': 'Nakhon Phanom', 'มุกดาหาร': 'Mukdahan', 'เชียงใหม่': 'Chiang Mai',
    'ลำพูน': 'Lamphun', 'ลำปาง': 'Lampang', 'อุตรดิตถ์': 'Uttaradit', 'แพร่': 'Phrae', 'น่าน': 'Nan',
    'พะเยา': 'Phayao', 'เชียงราย': 'Chiang Rai', 'แม่ฮ่องสอน': 'Mae Hong Son', 'นครสวรรค์': 'Nakhon Sawan',
    'อุทัยธานี': 'Uthai Thani', 'กำแพงเพชร': 'Kamphaeng Phet', 'ตาก': 'Tak', 'สุโขทัย': 'Sukhothai',
    'พิษณุโลก': 'Phitsanulok', 'พิจิตร': 'Phichit', 'เพชรบูรณ์': 'Phetchabun', 'ราชบุรี': 'Ratchaburi',
    'กาญจนบุรี': 'Kanchanaburi', 'สุพรรณบุรี': 'Suphan Buri', 'นครปฐม': 'Nakhon Pathom', 'สมุทรสาคร': 'Samut Sakhon',
    'สมุทรสงคราม': 'Samut Songkhram', 'เพชรบุรี': 'Phetchaburi', 'ประจวบคีรีขันธ์': 'Prachuap Khiri Khan',
    'นครศรีธรรมราช': 'Nakhon Si Thammarat', 'กระบี่': 'Krabi', 'พังงา': 'Phangnga', 'ภูเก็ต': 'Phuket',
    'สุราษฎร์ธานี': 'Surat Thani', 'ระนอง': 'Ranong', 'ชุมพร': 'Chumphon', 'สงขลา': 'Songkhla', 'สตูล': 'Satun',
    'ตรัง': 'Trang', 'พัทลุง': 'Phatthalung', 'ปัตตานี': 'Pattani', 'ยะลา': 'Yala', 'นราธิวาส': 'Narathiwat',
    'บึงกาฬ': 'buogkan'
}
df1_melted['province_eng'] = df1_melted['จังหวัด'].map(province_name_map)

# ==============================================================================
# ส่วนที่ 3: ส่วนควบคุมและแสดงผลของเว็บ (UI)
# ==============================================================================
st.title("Dashboard สรุปผลการจำหน่ายสินค้า OTOP ปีงบประมาณ 2567")

# --- ตัวควบคุม (Filters) ที่ Sidebar ---
st.sidebar.header("ตัวกรองข้อมูล")
selected_month = st.sidebar.selectbox(
    'เลือกเดือน:',
    options=month_cols
)
selected_province = st.sidebar.selectbox(
    'เลือกจังหวัด (เพื่อไฮไลท์และดูแนวโน้ม):',
    options=['ภาพรวม'] + df1.index.tolist()
)

# --- แสดงผลกราฟ ---

# ----- กราฟที่ 1: แผนที่ประเทศไทย (Choropleth Map) -----
st.subheader(f'ยอดขาย OTOP รายจังหวัด ประจำเดือน {selected_month}')
fig_map = px.choropleth(
    df1_melted[df1_melted['เดือน'] == selected_month],
    geojson=thailand_geojson,
    locations='province_eng',
    featureidkey="properties.name",
    color='ยอดขาย',
    color_continuous_scale="Viridis",
    scope="asia"
)
fig_map.update_geos(fitbounds="locations", visible=False)
fig_map.update_layout(margin={"r":0,"t":0,"l":0,"b":0})
st.plotly_chart(fig_map, use_container_width=True)


# --- สร้าง Layout แบบ 2 คอลัมน์ ---
col1, col2 = st.columns(2)

with col1:
    # ----- กราฟที่ 2: จัดอันดับจังหวัดตามยอดขาย (Bar Chart) -----
    st.subheader(f'20 อันดับจังหวัดยอดขายสูงสุด เดือน {selected_month}')
    monthly_data = df1[[selected_month]].sort_values(by=selected_month, ascending=False).reset_index()
    colors = ['#FFA500' if prov == selected_province else '#1f77b4' for prov in monthly_data['จังหวัด']]
    
    fig_bar = px.bar(
        monthly_data.head(20).sort_values(by=selected_month, ascending=True),
        x=selected_month,
        y='จังหวัด',
        orientation='h',
        labels={'จังหวัด': '', selected_month: 'ยอดขาย (บาท)'},
        height=500
    )
    fig_bar.update_traces(marker_color=colors)
    st.plotly_chart(fig_bar, use_container_width=True)

    # ----- กราฟที่ 4: ยอดขายตามช่องทาง (Stacked Bar) -----
    st.subheader(f'สัดส่วนยอดขายตามช่องทาง เดือน {selected_month}')
    channel_data_series = df2.loc[[m.strip() for m in df2.index if selected_month.split(' ')[0] in m]].iloc[0]
    channel_df = channel_data_series.reset_index()
    channel_df.columns = ['ช่องทาง', 'ยอดขาย']
    channel_df['เดือน'] = channel_data_series.name
    
    fig_channel = px.bar(
        channel_df, x='เดือน', y='ยอดขาย', color='ช่องทาง',
        labels={'เดือน': '', 'ยอดขาย': 'ยอดขาย (บาท)'}
    )
    st.plotly_chart(fig_channel, use_container_width=True)

with col2:
    # ----- กราฟที่ 3: แนวโน้มยอดขายเทียบค่าเฉลี่ย (Line Chart) -----
    st.subheader(f'แนวโน้มยอดขายของ {selected_province}')
    fig_line = go.Figure()
    if selected_province != 'ภาพรวม':
        fig_line.add_trace(go.Scatter(x=month_cols, y=df1.loc[selected_province], mode='lines+markers', name=selected_province))
    
    fig_line.add_trace(go.Scatter(x=month_cols, y=national_average, mode='lines', name='ค่าเฉลี่ยทั้งประเทศ', line=dict(dash='dash')))
    fig_line.update_layout(
        xaxis_title='เดือน', yaxis_title='ยอดขาย (บาท)', xaxis_tickangle=-45, height=500,
        legend=dict(yanchor="top", y=0.99, xanchor="left", x=0.01)
    )
    st.plotly_chart(fig_line, use_container_width=True)

    # ----- กราฟที่ 5: ยอดขายตามประเภทสินค้า (Stacked Bar) -----
    st.subheader(f'สัดส่วนยอดขายตามประเภทสินค้า เดือน {selected_month}')
    product_data_series = df3.loc[[m.strip() for m in df3.index if selected_month.split(' ')[0] in m]].iloc[0]
    product_df = product_data_series.reset_index()
    product_df.columns = ['ประเภทสินค้า', 'ยอดขาย']
    product_df['เดือน'] = product_data_series.name
    
    fig_product = px.bar(
        product_df, x='เดือน', y='ยอดขาย', color='ประเภทสินค้า',
        labels={'เดือน': '', 'ยอดขาย': 'ยอดขาย (บาท)'}
    )
    st.plotly_chart(fig_product, use_container_width=True)
