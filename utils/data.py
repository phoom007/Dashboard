# utils/data.py
# -*- coding: utf-8 -*-
import io
import json
import urllib.request
import pandas as pd
import streamlit as st

# =============================================================================
# 1) Embedded CSV (จากโค้ดต้นฉบับของคุณ)
# =============================================================================

# --- ข้อมูลชุดที่ 1: ยอดขายรายจังหวัด ---
province_data_csv = """
จังหวัด,ตุลาคม 2566,พฤศจิกายน 2566,ธันวาคม 2566,มกราคม 2567,กุมภาพันธ์ 2567,มีนาคม 2567,เมษายน 2567,พฤษภาคม 2567,มิถุนายน 2567,กรกฎาคม 2567,สิงหาคม 2567,กันยายน 2567
นนทบุรี,245625668.0,210766488.0,272289848.0,265082420.0,261525500.0,244857493.0,248708535.0,235904980.0,258507238.0,238045678.0,269465377.0,242563732.0
ปทุมธานี,192509104.0,197020127.0,203956285.0,192396842.0,178466573.0,175775064.0,112991880.0,94345643.0,101519237.0,71724372.0,70529872.0,64672082.0
พระนครศรีอยุธยา,689805749.0,696537075.0,701327486.0,722202515.0,678371275.0,439844454.0,618198300.0,601061413.0,491229452.0,657009792.0,645160574.0,321893299.0
สระบุรี,207633501.0,212469515.0,215802062.0,220108265.0,223968650.0,213836505.0,402224891.0,449988033.0,509932259.0,479368185.0,486239442.0,441379392.0
อ่างทอง,195522938.0,204574530.0,216361037.0,269824532.0,294743757.0,282620479.0,186123344.0,184467044.0,185097143.0,146992450.0,145481155.0,161114815.0
ลพบุรี,302598380.0,354487540.0,387219307.0,396704262.0,318658581.0,304992830.0,263248900.0,218301800.0,226603762.0,228851160.0,243027835.0,230071463.0
สิงห์บุรี,64800056.0,71171936.0,110680581.0,117566381.0,101557339.0,93827002.0,64800302.0,63128616.0,65937563.0,61033194.0,67858445.0,73141748.0
ชัยนาท,123038094.6,143969615.0,160440730.0,153473348.0,147140869.0,128454681.0,154474792.0,195296768.72,181488036.72,61000000.57,54904517.0,37654631.39
สมุทรปราการ,527190595.0,894290512.0,871325116.0,732189516.0,686518430.0,521320800.0,703105690.0,624959107.0,694960487.0,579469600.0,598724370.0,560214599.0
ฉะเชิงเทรา,97169643.0,101551882.0,96804386.0,103773112.0,110592906.0,121318611.0,162413580.0,157307693.0,146187118.0,133262296.0,121821116.0,113276641.0
ปราจีนบุรี,407773670.0,478753522.0,513500480.0,530114960.0,479266150.0,424144460.0,444937410.0,467424860.0,451868612.0,401613700.0,405412302.0,331721960.0
นครนายก,261589788.0,273255233.0,272838736.0,271684298.0,270892428.0,208843878.0,257014520.0,258831220.0,348783632.0,312364141.0,346590793.0,334211093.0
สระแก้ว,147501140.0,155957340.0,166525385.0,179072575.0,182721205.0,202826295.0,226578815.0,187693320.0,184840910.0,161276520.0,167036070.0,161501422.0
ราชบุรี,1222765499.5,1257307122.81,1235933815.83,1391692946.64,1191602033.86,1265872204.42,423412019.9,459511243.4,309078165.3,325202693.3,340191960.8,312208209.2
กาญจนบุรี,345558563.0,368885726.0,403195155.0,427198192.0,373437180.0,366206722.0,418866370.0,408869736.0,386792911.0,421308595.0,429406069.0,361950418.0
สุพรรณบุรี,516099158.0,478319832.0,472826198.0,521868974.0,494467057.0,580345991.0,358442062.0,315801794.0,289788862.0,255254655.0,223100560.0,180136600.0
นครปฐม,1810589575.79,1830860310.22,1963968968.92,1955408807.42,1954883081.88,1919598387.14,1771517517.78,1731734341.89,1758010342.66,1863373355.6,1925794997.2,1854357519.0
สมุทรสาคร,588103299.0,614015069.0,733224869.0,745738221.0,630053822.0,636150734.0,601140360.0,573119015.0,559159730.0,568084590.0,671334755.0,641715155.0
สมุทรสงคราม,161394863.0,146823701.0,142192601.0,171551067.0,156112596.0,197760020.02,207244720.02,217502965.02,223492665.02,164040790.02,182141764.9,192289985.0
เพชรบุรี,623819113.0,681612345.0,720166309.0,712800025.0,700868823.0,692580869.0,758930950.0,733465450.0,731656615.0,741667616.0,719179724.0,718951119.0
ประจวบคีรีขันธ์,112448720.0,130067620.0,167332730.0,155994660.0,130292730.0,129966210.0,130346840.0,121911470.0,119325370.0,121227690.0,124021970.0,117459550.0
นครศรีธรรมราช,361521865.0,362386941.0,407677146.0,387563463.0,378773166.0,313583958.0,261544785.0,235817693.0,239068105.0,241571890.0,236243382.0,232347252.0
สุราษฎร์ธานี,601806053.0,631265647.0,651642751.0,664035220.0,687890359.0,668942950.0,656590809.0,629971642.0,742670997.0,563265433.0,551735936.0,555521453.0
ชุมพร,171636312.0,177427382.0,196081903.0,195267388.0,188006377.0,189176050.0,195232984.0,190910539.0,195465680.0,195147876.0,193583001.0,171133126.0
พัทลุง,200436320.0,201022659.0,212721928.0,204764582.0,200919656.0,198140882.0,177509546.0,176227804.0,176809349.0,177042034.0,177478673.0,175494603.0
กระบี่,147544888.0,162226629.0,176973249.0,172056840.67,167136786.41,158605695.75,86866402.3,72888767.41,71551857.93,67103871.25,79711886.28,76503127.67
พังงา,124582501.0,128427206.0,136151823.0,139161651.0,148491630.0,154635644.0,117075833.0,113894231.6,113643797.6,113696376.6,110713093.6,113829697.6
ภูเก็ต,291398822.0,302757012.0,312923282.0,299551210.0,262268850.0,253499600.0,137695700.0,91906190.0,110960940.0,118611640.0,122654640.0,131206140.0
ระนอง,170869424.0,169282092.0,160516210.0,181616224.0,179722191.0,163454234.0,208620794.0,214954678.0,220345826.0,195723108.0,226285155.0,201101706.0
ตรัง,271210368.0,269345250.0,282059710.0,278312310.0,262633270.0,262840690.0,275489350.0,274747030.0,272676475.0,276596940.0,277074175.0,274611000.0
สงขลา,396832112.0,393751851.0,422828940.0,464864289.0,472157112.0,446092445.0,321546991.0,312369982.0,309427905.0,385748023.0,338552971.0,347421550.0
สตูล,141214981.0,150844063.0,156032331.0,155496911.0,157335061.0,156079435.0,169771339.0,161702172.0,166753740.0,175456982.0,182962317.0,177883312.0
ปัตตานี,375811690.0,384522240.0,398396828.0,385459153.0,371969292.0,348117989.0,344341498.0,348091318.0,352135775.0,366454438.0,374095371.0,372762202.0
ยะลา,269310620.0,288683873.0,364142199.0,320083544.0,321308975.0,298848307.0,326235980.0,319467149.0,312643800.0,295180370.0,287557085.0,277719650.0
นราธิวาส,239184500.0,251817853.0,263697647.0,264924549.0,248635543.0,236291603.0,278613498.0,276033900.0,276054052.0,275868915.0,282059183.0,270114328.0
ชลบุรี,296199657.6,308132372.6,362765626.8,394321370.0,294567475.0,291872826.0,302040141.0,300593351.0,315460611.0,289567095.0,438522705.0,362134711.0
ระยอง,297001037.0,302287453.0,309664608.0,302016253.0,290142944.0,293242483.0,312010173.0,403392496.0,382210246.0,327798841.0,328304989.0,295484807.0
จันทบุรี,212131805.0,328386726.0,509334711.0,510439915.0,353728020.0,505843588.0,76720598.0,132898318.0,80927261.0,52644089.0,52560541.0,55121737.0
ตราด,131676671.0,130804167.0,135664537.0,135061967.0,139114065.0,145406455.0,143441305.0,150690094.0,154122994.0,155700205.0,159202895.0,307711209.0
บึงกาฬ,136305618.0,137878150.0,144368538.0,142159047.0,132086569.0,117589121.0,135478015.0,136494558.0,137284966.0,137045731.0,140558124.0,130302855.0
หนองบัวลำภู,201242729.0,202846469.0,235548708.0,222729440.0,228086790.0,213105726.0,172894046.0,180401216.0,187335416.0,179008889.0,192402756.0,189954756.0
อุดรธานี,729417412.0,766708566.0,856869341.0,793100888.0,764884987.0,759453657.0,790247483.0,797822309.0,802029380.0,810833854.0,765570543.0,679121612.0
เลย,283857523.04,299288795.0,329779014.0,342416912.48,312598039.02,271641198.5,266955787.05,278620773.0,279912346.58,286212486.91,277529390.42,231202297.0
หนองคาย,119423129.0,120894940.0,134469272.0,153457701.0,134150299.0,146890060.0,127435522.0,137358624.0,141361186.0,144274966.0,160218174.0,163737624.0
สกลนคร,426105889.76,441275995.19,459265192.11,472804692.02,496103144.0,419627572.0,467771649.8,450273552.8,363715244.0,341344767.0,361986168.0,312025994.0
นครพนม,172959100.0,191610850.0,212346404.0,226627315.0,239777684.0,237193970.0,204253915.0,194426061.0,187746897.0,174673547.0,160342332.0,134248480.0
มุกดาหาร,146850683.0,147997807.0,146993440.0,157844191.0,144988597.0,143346264.0,111581855.0,92537359.0,100044183.0,97065003.0,98071428.0,105948530.0
ขอนแก่น,1215123406.0,1238634039.0,1315581409.6,1361906391.6,1340337698.6,1212748339.6,1100123305.22,1164192289.74,1151642234.6,1019982493.04,383291126.0,389327152.0
มหาสารคาม,281045237.72,280846345.74,364753828.44,395048899.68,364984109.16,363610714.18,352667505.78,328270873.7,321973225.6,248722853.92,256936210.9,129920947.18
ร้อยเอ็ด,448922016.0,588424411.0,639947301.0,699619191.0,629227456.0,749751839.0,512923061.0,529836011.0,487840931.0,424607701.0,471009351.0,364842199.0
กาฬสินธุ์,416256370.0,450132019.0,842126243.0,836748890.0,699035497.0,619273572.0,360258725.0,497143039.0,664841342.0,548941810.0,612743995.0,409658631.0
ศรีสะเกษ,717473145.0,727576637.0,799840507.0,862314770.0,890142934.0,818824894.0,802918434.0,663911585.0,580924000.0,543078522.0,524573931.0,521787794.0
อุบลราชธานี,732828739.0,752734543.0,801413240.0,800754350.0,784532344.0,807457937.34,798949647.75,792802277.75,823717964.75,820771940.75,817692458.97,793796695.97
ยโสธร,127648780.0,194198350.0,214861690.0,201452410.0,170916100.0,182215468.0,187535222.0,199950720.0,197678087.0,181226940.0,163937340.0,168105670.0
อำนาจเจริญ,300025728.0,327535786.0,344961622.0,357539249.0,340179854.0,342265744.0,355542155.0,337210614.0,338334987.0,324380343.0,325115613.0,312177657.0
นครราชสีมา,938836120.0,951955923.0,971998825.0,899985815.0,539106216.0,400863649.0,946370796.0,944629925.0,945835087.0,952601489.0,1504848627.0,401528519.0
บุรีรัมย์,345642249.0,342127083.0,361477480.0,367898865.0,360963155.0,376223487.0,356259091.0,358983270.0,367123086.0,403438541.0,438963036.0,397181866.0
สุรินทร์,431650706.0,452446360.0,490514134.0,498821400.0,501934460.0,462181595.0,465099225.0,471555335.0,490764865.0,502565575.0,525047340.0,440697410.0
ชัยภูมิ,177714463.95,236094618.95,256716725.95,312093798.95,326466597.95,271714007.95,292863604.9,240282032.8,249353852.2,244402447.0,246586636.05,198831009.05
เชียงใหม่,1180854572.0,1337763856.0,1480465437.0,1959962793.0,2123559119.0,2054964260.0,1280801356.0,1018499421.0,1021207790.22,1016829312.22,1042741682.22,833182393.0
ลำพูน,467608380.0,475935980.0,489554430.0,410836060.0,413430310.0,644021580.0,566677950.0,486032650.0,504268700.0,360447300.0,301309660.0,277917990.0
ลำปาง,161871689.0,182890979.5,212804705.5,201106531.0,159306152.5,162270818.0,167259435.0,147661693.0,152006990.0,164027652.0,169107481.5,155393910.0
แม่ฮ่องสอน,44555547.0,79412366.0,90251780.0,80697801.0,57296062.0,31952843.0,16599287.0,18440278.0,35200840.0,23787593.0,27395472.7,22091498.48
แพร่,162684719.0,151635723.0,172051750.0,148527288.0,148858491.0,169817585.0,145970780.0,148924665.0,153378828.0,157225966.0,153824813.0,160556136.0
น่าน,158198989.23,156896649.23,162614475.0,232008840.0,231547030.0,229489657.0,193083465.0,199103426.0,184711276.0,162575565.0,166341200.0,113589078.0
พะเยา,188244925.0,212206975.0,267313544.0,276616153.0,226243389.0,209366435.0,129670650.0,173188817.0,267492831.0,233462240.0,223065439.0,132976656.0
เชียงราย,436788585.0,461632108.0,554074447.0,552473908.0,586104438.0,606550631.0,447639629.0,407058946.0,410626441.0,424207953.0,490236928.0,407018645.0
อุตรดิตถ์,115900547.0,122493777.0,123042834.0,113546070.0,176590356.0,198972772.0,198774579.0,536063554.0,465922517.0,582746082.0,263009913.0,62877610.0
ตาก,297355883.0,313889430.0,345671471.0,334229102.0,281968668.0,288213347.0,286490609.0,270351119.0,266752016.0,264133870.0,275544850.0,229685629.0
สุโขทัย,160644094.0,210481010.0,237410970.0,210525890.0,194952180.0,163939936.0,167242000.0,176102517.0,173089248.0,174754414.0,219844484.0,146623632.0
พิษณุโลก,131942462.0,134127282.0,145306050.0,178597171.0,144462410.0,118385730.0,133296881.0,90514834.0,60310818.0,92726538.0,32781091.0,20448559.0
เพชรบูรณ์,284561745.0,328764965.0,354917200.0,599386590.0,491307660.0,306030143.4,244153459.9,304646734.9,261126531.9,258558333.7,212931190.0,201385101.0
นครสวรรค์,322786629.0,349090748.0,423578298.0,474364591.0,412332743.0,376699866.0,308099187.0,286949330.0,289465975.0,282020211.0,308253477.0,273029328.33
อุทัยธานี,174962582.0,168963282.0,187845362.0,179388622.0,198764546.0,149731660.0,167614400.0,164935250.0,176846140.0,170599512.0,123580240.0,110319504.0
กำแพงเพชร,192411656.74,203671074.66,215401298.18,221469130.49,227660451.31,219536660.02,279432383.44,262229547.66,297656298.84,291073699.18,332922365.24,252512186.15
พิจิตร,59406106.0,81473844.0,88704641.0,103092206.0,130911604.0,92736265.0,103187586.0,88278970.0,78310425.0,77037778.0,78708087.0,71438629.0
"""

# --- ข้อมูลชุดที่ 2: สรุปรายได้ตามช่องทาง ---
channel_data_csv = """
เดือน,ในประเทศ(ออฟไลน์),ในประเทศ(ออนไลน์),ต่างประเทศ(ออฟไลน์),ต่างประเทศ(ออนไลน์)
ตุลาคม 2566,24868670112.17,886262153.26,607544410.0,71538224.5
พฤศจิกายน 2566,26439753164.45,1026477222.72,723574467.28,78801340.45
ธันวาคม 2566,28954077120.63,1177260077.41,748105136.89,82586788.4
มกราคม 2567,29885339609.31,1303359324.92,809590383.64,75306404.08
กุมภาพันธ์ 2567,28126566594.25,1315772579.05,782323562.02,72077164.37
มีนาคม 2567,26907257131.47,1258881837.9,933832853.22,74505705.73
เมษายน 2567,24803702338.77,1042086451.18,632408544.17,71994873.72
พฤษภาคม 2567,24601808404.85,965282577.46,652652365.38,63124698.7
มิถุนายน 2567,24712722210.06,984713465.26,574612094.17,62974699.43
กรกฎาคม 2567,23810114022.2,1002527591.62,510170421.75,63931083.49
สิงหาคม 2567,23906870634.7,1008090662.03,538531178.45,52252146.6
กันยายน 2567,20259886628.4,881571468.5,599405392.45,55166737.67
"""

# --- ข้อมูลชุดที่ 3: สรุปตามประเภทสินค้า ---
product_type_data_csv = """
เดือน,อาหาร,เครื่องดื่ม,ผ้าและเครื่องแต่งกาย,เครื่องใช้และเครื่องประดับตกแต่ง,สมุนไพรที่ไม่ใช่อาหารและยา
ตุลาคม 2566,12956019480.47,1423645106.48,4818821484.0,5085298737.35,2150230091.63
พฤศจิกายน 2566,13874527663.67,1538536934.9,5049333205.51,5477161358.43,2329047032.39
ธันวาคม 2566,14893424956.72,1707495161.43,5798785720.28,5987124582.29,2575198702.61
มกราคม 2567,15871436806.7,1748397669.64,5657510920.48,6181388333.85,2614861991.28
กุมภาพันธ์ 2567,15027998338.19,1640612294.29,5219386481.68,5926118361.58,2482624423.95
มีนาคม 2567,14451419224.52,1573213650.63,5089245091.96,5702875881.84,2357723679.37
เมษายน 2567,12741034100.98,1388561768.71,4857378158.83,5411151289.74,2152066889.58
พฤษภาคม 2567,12805070707.26,1330358397.25,4837850317.91,5194650966.79,2114937657.18
มิถุนายน 2567,12562536620.17,1339483273.77,5013026868.8,5271892971.6,2148082734.58
กรกฎาคม 2567,12242538057.1,1320149446.44,4763790762.28,5002477580.17,2057787273.07
สิงหาคม 2567,12229630799.54,1375201089.81,4764279727.17,5089532192.09,2047100813.17
กันยายน 2567,10523566770.03,1205246732.06,3764020572.13,4370073038.02,1933123114.78
"""

# =============================================================================
# 2) Province TH->EN mapping (สำหรับแผนที่)
# =============================================================================
PROVINCE_NAME_MAP = {
    'กรุงเทพมหานคร': 'Bangkok', 'สมุทรปราการ': 'Samut Prakan', 'นนทบุรี': 'Nonthaburi', 'ปทุมธานี': 'Pathum Thani',
    'พระนครศรีอยุธยา': 'Phra Nakhon Si Ayutthaya', 'อ่างทอง': 'Ang Thong', 'ลพบุรี': 'Lopburi', 'สิงห์บุรี': 'Sing Buri',
    'ชัยนาท': 'Chai Nat', 'สระบุรี': 'Saraburi', 'ชลบุรี': 'Chon Buri', 'ระยอง': 'Rayong', 'จันทบุรี': 'Chanthaburi',
    'ตราด': 'Trat', 'ฉะเชิงเทรา': 'Chachoengsao', 'ปราจีนบุรี': 'Prachin Buri', 'นครนายก': 'Nakhon Nayok',
    'สระแก้ว': 'Sa Kaeo', 'นครราชสีมา': 'Nakhon Ratchasima', 'บุรีรัมย์': 'Buri Ram', 'สุรินทร์': 'Surin',
    'ศรีสะเกษ': 'Si Sa Ket', 'อุบลราชธานี': 'Ubon Ratchathani', 'ยโสธร': 'Yasothon', 'ชัยภูมิ': 'Chaiyaphum',
    'อำนาจเจริญ': 'Amnat Charoen', 'หนองบัวลำภู': 'Nong Bua Lam Phu', 'ขอนแก่น': 'Khon Kaen', 'อุดรธานี': 'Udon Thani',
    'เลย': 'Loei', 'หนองคาย': 'Nong Khai', 'มหาสารคาม': 'Maha Sarakham', 'ร้อยเอ็ด': 'Roi Et', 'กาฬสินธุ์': 'Kalasin',
    'สกลนคร': 'Sakon Nakhon', 'นครพนม': 'Nakhon Phanom', 'มุกดาหาร': 'Mukdahan', 'เชียงใหม่': 'Chiang Mai',
    'ลำพูน': 'Lamphun', 'ลำปาง': 'Lampang', 'อุตรดิตถ์': 'Uttaradit', 'แพร่': 'Phrae', 'น่าน': 'Nan',
    'พะเยา': 'Phayao', 'เชียงราย': 'Chiang Rai', 'แม่ฮ่องสอน': 'Mae Hong Son', 'นครสวรรค์': 'Nakhon Sawan',
    'อุทัยธานี': 'Uthai Thani', 'กำแพงเพชร': 'Kamphaeng Phet', 'ตาก': 'Tak', 'สุโขทัย': 'Sukhothai',
    'พิษณุโลก': 'Phitsanulok', 'พิจิตร': 'Phichit', 'เพชรบูรณ์': 'Phetchabun', 'ราชบุรี': 'Ratchaburi',
    'กาญจนบุรี': 'Kanchanaburi', 'สุพรรณบุรี': 'Suphan Buri', 'นครปฐม': 'Nakhon Pathom', 'สมุทรสาคร': 'Samut Sakhon',
    'สมุทรสงคราม': 'Samut Songkhram', 'เพชรบุรี': 'Phetchaburi', 'ประจวบคีรีขันธ์': 'Prachuap Khiri Khan',
    'นครศรีธรรมราช': 'Nakhon Si Thammarat', 'กระบี่': 'Krabi', 'พังงา': 'Phangnga', 'ภูเก็ต': 'Phuket',
    'สุราษฎร์ธานี': 'Surat Thani', 'ระนอง': 'Ranong', 'ชุมพร': 'Chumphon', 'สงขลา': 'Songkhla', 'สตูล': 'Satun',
    'ตรัง': 'Trang', 'พัทลุง': 'Phatthalung', 'ปัตตานี': 'Pattani', 'ยะลา': 'Yala', 'นราธิวาส': 'Narathiwat',
    'บึงกาฬ': 'Bueng Kan'
}

# =============================================================================
# 3) Data loaders
# =============================================================================

@st.cache_data
def load_all_data():
    """โหลดข้อมูลทั้งหมดจากสตริง CSV ที่ฝังไว้ และเตรียม DataFrame สำหรับกราฟ/แผนที่"""
    # โหลดจากสตริง
    df1 = pd.read_csv(io.StringIO(province_data_csv))
    df2 = pd.read_csv(io.StringIO(channel_data_csv))
    df3 = pd.read_csv(io.StringIO(product_type_data_csv))

    # เตรียม df1 (รายจังหวัด)
    months = [c for c in df1.columns if ('2566' in c) or ('2567' in c)]
    df1.set_index('จังหวัด', inplace=True)

    # เตรียม df2, df3
    df2.set_index('เดือน', inplace=True)
    df3.set_index('เดือน', inplace=True)

    # melt สำหรับแผนที่
    df1_melted = df1.reset_index().melt(id_vars='จังหวัด', var_name='เดือน', value_name='ยอดขาย')
    df1_melted['province_eng'] = df1_melted['จังหวัด'].map(PROVINCE_NAME_MAP)

    # ค่าเฉลี่ยประเทศ (เฉลี่ยรายเดือน across provinces)
    national_average = df1[months].mean()

    return df1, df2, df3, df1_melted, national_average

@st.cache_data
def load_all_data():
    """
    คืนค่า 6 รายการตามลำดับ:
    1) df1: ยอดขายรายจังหวัด (index='จังหวัด')
    2) df2: รายได้ตามช่องทาง (index='เดือน')
    3) df3: รายได้ตามประเภทสินค้า (index='เดือน')
    4) df1_melted: สำหรับแผนที่ (มี 'province_eng')
    5) national_average: ค่าเฉลี่ยทั้งประเทศรายเดือนของ df1 (Series)
    6) month_cols: รายชื่อคอลัมน์เดือนของ df1
    """
    # อ่านจากสตริง CSV
    df1 = pd.read_csv(io.StringIO(province_data_csv.strip()))
    df2 = pd.read_csv(io.StringIO(channel_data_csv.strip()))
    df3 = pd.read_csv(io.StringIO(product_type_data_csv.strip()))

    # ตรวจคอลัมน์หลัก
    if "จังหวัด" not in df1.columns:
        raise ValueError("df1 ต้องมีคอลัมน์ 'จังหวัด'")
    if "เดือน" not in df2.columns:
        raise ValueError("df2 ต้องมีคอลัมน์ 'เดือน'")
    if "เดือน" not in df3.columns:
        raise ValueError("df3 ต้องมีคอลัมน์ 'เดือน'")

    # ตั้ง index
    df1.set_index("จังหวัด", inplace=True)
    df2.set_index("เดือน", inplace=True)
    df3.set_index("เดือน", inplace=True)

    # รายชื่อคอลัมน์เดือน (ของ df1)
    month_cols = [c for c in df1.columns if ("2566" in c or "2567" in c)]
    if not month_cols:
        month_cols = list(df1.columns)

    # Melt สำหรับแผนที่
    df1_melted = df1.reset_index().melt(id_vars="จังหวัด", var_name="เดือน", value_name="ยอดขาย")

    # Mapping ไทย->อังกฤษ (เฉพาะจังหวัดที่มีใน GeoJSON)
    province_name_map = {
        'กรุงเทพมหานคร': 'Bangkok', 'สมุทรปราการ': 'Samut Prakan', 'นนทบุรี': 'Nonthaburi', 'ปทุมธานี': 'Pathum Thani',
        'พระนครศรีอยุธยา': 'Phra Nakhon Si Ayutthaya', 'อ่างทอง': 'Ang Thong', 'ลพบุรี': 'Lopburi', 'สิงห์บุรี': 'Sing Buri',
        'ชัยนาท': 'Chai Nat', 'สระบุรี': 'Saraburi', 'ชลบุรี': 'Chon Buri', 'ระยอง': 'Rayong', 'จันทบุรี': 'Chanthaburi',
        'ตราด': 'Trat', 'ฉะเชิงเทรา': 'Chachoengsao', 'ปราจีนบุรี': 'Prachin Buri', 'นครนายก': 'Nakhon Nayok',
        'สระแก้ว': 'Sa Kaeo', 'นครราชสีมา': 'Nakhon Ratchasima', 'บุรีรัมย์': 'Buri Ram', 'สุรินทร์': 'Surin',
        'ศรีสะเกษ': 'Si Sa Ket', 'อุบลราชธานี': 'Ubon Ratchathani', 'ยโสธร': 'Yasothon', 'ชัยภูมิ': 'Chaiyaphum',
        'อำนาจเจริญ': 'Amnat Charoen', 'หนองบัวลำภู': 'Nong Bua Lam Phu', 'ขอนแก่น': 'Khon Kaen', 'อุดรธานี': 'Udon Thani',
        'เลย': 'Loei', 'หนองคาย': 'Nong Khai', 'มหาสารคาม': 'Maha Sarakham', 'ร้อยเอ็ด': 'Roi Et', 'กาฬสินธุ์': 'Kalasin',
        'สกลนคร': 'Sakon Nakhon', 'นครพนม': 'Nakhon Phanom', 'มุกดาหาร': 'Mukdahan', 'เชียงใหม่': 'Chiang Mai',
        'ลำพูน': 'Lamphun', 'ลำปาง': 'Lampang', 'อุตรดิตถ์': 'Uttaradit', 'แพร่': 'Phrae', 'น่าน': 'Nan',
        'พะเยา': 'Phayao', 'เชียงราย': 'Chiang Rai', 'แม่ฮ่องสอน': 'Mae Hong Son', 'นครสวรรค์': 'Nakhon Sawan',
        'อุทัยธานี': 'Uthai Thani', 'กำแพงเพชร': 'Kamphaeng Phet', 'ตาก': 'Tak', 'สุโขทัย': 'Sukhothai',
        'พิษณุโลก': 'Phitsanulok', 'พิจิตร': 'Phichit', 'เพชรบูรณ์': 'Phetchabun', 'ราชบุรี': 'Ratchaburi',
        'กาญจนบุรี': 'Kanchanaburi', 'สุพรรณบุรี': 'Suphan Buri', 'นครปฐม': 'Nakhon Pathom', 'สมุทรสาคร': 'Samut Sakhon',
        'สมุทรสงคราม': 'Samut Songkhram', 'เพชรบุรี': 'Phetchaburi', 'ประจวบคีรีขันธ์': 'Prachuap Khiri Khan',
        'นครศรีธรรมราช': 'Nakhon Si Thammarat', 'กระบี่': 'Krabi', 'พังงา': 'Phangnga', 'ภูเก็ต': 'Phuket',
        'สุราษฎร์ธานี': 'Surat Thani', 'ระนอง': 'Ranong', 'ชุมพร': 'Chumphon', 'สงขลา': 'Songkhla', 'สตูล': 'Satun',
        'ตรัง': 'Trang', 'พัทลุง': 'Phatthalung', 'ปัตตานี': 'Pattani', 'ยะลา': 'Yala', 'นราธิวาส': 'Narathiwat',
        'บึงกาฬ': 'Bueng Kan'
    }
    df1_melted["province_eng"] = df1_melted["จังหวัด"].map(province_name_map)

    # ค่าเฉลี่ยประเทศรายเดือน (Series)
    national_average = df1[month_cols].mean()

    # >>> รีเทิร์นครบ 6 ค่า <<<
    return df1, df2, df3, df1_melted, national_average, month_cols

# =============================================================================
# 4) Utilities: month_cols ให้โมดูลอื่นเรียกใช้
# =============================================================================

def _extract_month_cols():
    demo = pd.read_csv(io.StringIO(province_data_csv))
    cols = [c for c in demo.columns if ('2566' in c) or ('2567' in c)]
    return cols

month_cols = _extract_month_cols()


